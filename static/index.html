<!DOCTYPE html>
<html>

<head>
    <title>My WINIT example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <link rel="stylesheet" href="style.css" />
    <link rel="modulepreload" href="runtime-python/module.js" />
    <link rel="modulepreload" href="runtime-python/worker.js" />
    <link rel="modulepreload" href="runtime-python/wasm.js" />
    <link rel="modulepreload" href="wasm-tools/wasm.js" />

    <script type="module">
        const LOG_SRC = "[main]";
        import * as WasmTools from "./wasm-tools/wasm.js";
        import * as PythonRuntime from "./runtime-python/module.js";

        await WasmTools.default();

        console.info(WasmTools);
        console.info(WasmTools.Channel);

        const BUFFER_SIZE = 65536;
        let channel_buffers = [new SharedArrayBuffer(4 * 4), new SharedArrayBuffer(BUFFER_SIZE)];

        // FIXME the message receiver in worker.js should be ready at this point, but without the delay it misses the messages somehow
        window.setTimeout(() => {
            console.info(LOG_SRC, "setting up channel");
            PythonRuntime.set_channel_buffers(channel_buffers);
            WasmTools.set_channel_buffers(channel_buffers);
            console.info(LOG_SRC, "starting python runtime");
            PythonRuntime.run();
        }, 2000);

        window.setTimeout(() => {
            console.log(LOG_SRC, "sending message to python runtime");
            WasmTools.send();
        }, 5000);

        // async function run() {
    </script>
    <!-- 
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.info("start");
            greet('World');
        });
    </script> -->
</head>

<body>
    nothing
</body>

</html>